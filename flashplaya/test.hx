import flash.events.SampleDataEvent;import flash.events.TimerEvent;import flash.media.Sound;import flash.media.SoundChannel;import flash.external.ExternalInterface;import flash.net.URLVariables;import flash.Vector;import flash.utils.ByteArray;import flash.utils.Timer;class Test {  static var channel:SoundChannel;  static var clip:flash.display.MovieClip;  static function base64Decode(input: String) : Array<Int> {    var BASE64:String = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";    var output:Array<Int> = [];    var enc1 = BASE64.indexOf(input.charAt(0));    var enc2 = BASE64.indexOf(input.charAt(1));    var enc3 = BASE64.indexOf(input.charAt(2));    var enc4 = BASE64.indexOf(input.charAt(3));    var chr1 = (enc1 << 2) | (enc2 >> 4);    var chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);    var chr3 = ((enc3 & 3) << 6) | enc4;    output.push(chr1 & 0xFF);    if (enc3 != 64) {      output.push(chr2 & 0xFF);    }    if (enc4 != 64) {      output.push(chr3 & 0xFF);    }    return output;  }    static function statusLED(color:Int):Void {/*      clip.graphics.beginFill(color);      clip.graphics.drawRect(100,100,20,20);      clip.graphics.endFill();*/    }    static function sineWaveGenerator(event:SampleDataEvent) {      if(ExternalInterface.available) {        try {          statusLED(0x00FF00);          var data:String = ExternalInterface.call("genSound", 2048 * 2, event.position);          statusLED(0xFFFF00);          var len:Int = Math.floor(data.length / 4);          var bytes:ByteArray = new ByteArray();          for(i in 0...len) {            var decoded: Array<Int> = base64Decode(data.substr(i*4, 4));            var decodedLen = decoded.length;            for(j in 0...decodedLen) {              bytes.writeByte(decoded[j]);            }          }          statusLED(0x0000FF);          len = Math.floor(bytes.length / 2);          bytes.position = 0;          for(i in 0...len) {            var dings:Int = 0;            dings += bytes.readUnsignedByte();            dings += bytes.readUnsignedByte() << 8;            var val:Float = (dings - 32768.0) / 32768.0;            event.data.writeFloat(val);            event.data.writeFloat(val);          }        } catch (msg:Dynamic) {          trace(msg);        }        statusLED(0x00FFFF);      }    }    static function updatePeakMeter(event:TimerEvent) {      var left:Float = channel.leftPeak;      var right:Float = channel.rightPeak;      clip.graphics.beginFill(0xFFFFFF);      clip.graphics.drawRect(0, 0, 200, 30);      clip.graphics.endFill();      clip.graphics.beginFill(0xFF0000);      clip.graphics.drawRect(0,0,10 + (190 * left), 10);      clip.graphics.endFill();      clip.graphics.beginFill(0xFF0000);      clip.graphics.drawRect(0,20,10 + (190 * right), 10);      clip.graphics.endFill();    }    static function main() {      clip = flash.Lib.current;      trace("Started V0.1 BUILD 004");      flash.system.Security.allowDomain("localhost");      // trace(flash.system.Security.sandboxType);      var mySound:Sound = new Sound();      mySound.addEventListener(SampleDataEvent.SAMPLE_DATA,sineWaveGenerator);      channel = mySound.play();      var peakTimer:Timer = new Timer(100);      peakTimer.addEventListener(TimerEvent.TIMER, updatePeakMeter);      peakTimer.start();    }}